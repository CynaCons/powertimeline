rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Collection group rule for timelines (enables collectionGroup queries)
    // The {path=**} wildcard matches any path depth
    match /{path=**}/timelines/{timelineId} {
      // Public timelines can be read by anyone
      // Private timelines require authentication and ownership
      allow read: if resource.data.visibility == 'public'
                    || resource.data.visibility == 'unlisted'
                    || (request.auth != null && resource.data.ownerId == request.auth.uid);

      // Only authenticated users can create timelines
      // Timeline must be owned by the authenticated user
      allow create: if request.auth != null &&
                      request.resource.data.ownerId == request.auth.uid;

      // Only the owner can delete their timelines
      allow delete: if request.auth != null &&
                      resource.data.ownerId == request.auth.uid;

      // Allow anyone to increment viewCount (for analytics)
      // Allow owners to update any field
      allow update: if (request.resource.data.diff(resource.data).affectedKeys().hasOnly(['viewCount']))
                    || (request.auth != null && resource.data.ownerId == request.auth.uid);
    }

    // Users collection
    match /users/{userId} {
      // Anyone can read user documents (public profiles)
      allow read: if true;

      // Only authenticated users can create/update their own profile
      // User document ID must match authenticated user ID
      allow create, update: if request.auth != null && request.auth.uid == userId;

      // Only admins can delete users
      allow delete: if request.auth != null &&
                       get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';

      // Timelines subcollection (nested under users)
      match /timelines/{timelineId} {
        // Public timelines can be read by anyone
        // Unlisted timelines can be read by anyone with the link
        // Private timelines can only be read by the owner
        allow read: if resource.data.visibility == 'public'
                      || resource.data.visibility == 'unlisted'
                      || (request.auth != null && resource.data.ownerId == request.auth.uid);

        // Only authenticated users can create timelines
        // Timeline must be owned by the authenticated user
        // Timeline must be in the owner's collection
        allow create: if request.auth != null &&
                        request.resource.data.ownerId == request.auth.uid &&
                        request.auth.uid == userId;

        // Only the owner can delete their timelines
        allow delete: if request.auth != null &&
                        resource.data.ownerId == request.auth.uid &&
                        request.auth.uid == userId;

        // Allow anyone to increment viewCount (for analytics)
        // Allow owners to update any field
        allow update: if (request.resource.data.diff(resource.data).affectedKeys().hasOnly(['viewCount']))
                      || (request.auth != null && resource.data.ownerId == request.auth.uid && request.auth.uid == userId);

        // Events subcollection (nested under timelines)
        // v0.5.0.1 - Event Persistence Optimization
        // v0.5.6 - Security Fix: Properly restrict event access
        match /events/{eventId} {
          // SECURITY FIX: Events visibility must be explicitly checked
          // Firestore subcollection rules do NOT inherit parent permissions
          // We must explicitly check timeline visibility here

          // Strategy: Check parent timeline visibility via get()
          // Public/Unlisted timelines: Anyone can read events
          // Private timelines: Only owner can read events
          allow read: if get(/databases/$(database)/documents/users/$(userId)/timelines/$(timelineId)).data.visibility == 'public'
                      || get(/databases/$(database)/documents/users/$(userId)/timelines/$(timelineId)).data.visibility == 'unlisted'
                      || (request.auth != null && request.auth.uid == userId);

          // Only the timeline owner (authenticated user) can create/update/delete events
          allow create, update, delete: if request.auth != null &&
                                          request.auth.uid == userId;
        }
      }
    }

    // Activity logs collection (admin only)
    match /activityLogs/{logId} {
      // Only admins can read activity logs
      allow read: if request.auth != null &&
                     get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';

      // Only admins can create activity logs
      allow create: if request.auth != null &&
                       get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';

      // Activity logs cannot be updated or deleted
      allow update, delete: if false;
    }
  }
}
