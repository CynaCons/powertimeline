rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Collection group rule for timelines (enables collectionGroup queries)
    // The {path=**} wildcard matches any path depth
    // v0.5.7 - Restrict to public/unlisted timelines only (security fix)
    // Note: Default to public if visibility not set (backwards compatibility)
    match /{path=**}/timelines/{timelineId} {
      // Only allow reads for public/unlisted timelines, or by the owner
      // If visibility field doesn't exist, default to allowing read (backwards compat)
      allow read: if !('visibility' in resource.data)
                    || resource.data.visibility == 'public'
                    || resource.data.visibility == 'unlisted'
                    || (request.auth != null && resource.data.ownerId == request.auth.uid);

      // Allow anyone to update viewCount only (for analytics)
      // This uses a simpler check that works with increment()
      allow update: if request.resource.data.keys().hasAll(resource.data.keys())
                    && request.resource.data.viewCount is int
                    && request.resource.data.viewCount > resource.data.viewCount;

      // Only authenticated users can create timelines
      allow create: if request.auth != null &&
                      request.resource.data.ownerId == request.auth.uid;

      // Only the owner can delete their timelines
      allow delete: if request.auth != null &&
                      resource.data.ownerId == request.auth.uid;
    }

    // Users collection
    match /users/{userId} {
      // Anyone can read user documents (public profiles)
      allow read: if true;

      // Only authenticated users can create/update their own profile
      // User document ID must match authenticated user ID
      allow create, update: if request.auth != null && request.auth.uid == userId;

      // Only admins can delete users
      allow delete: if request.auth != null &&
                       get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';

      // Timelines subcollection (nested under users)
      match /timelines/{timelineId} {
        // Public timelines can be read by anyone
        // Unlisted timelines can be read by anyone with the link
        // Private timelines can only be read by the owner
        // Default to public if visibility not set (backwards compatibility)
        allow read: if !('visibility' in resource.data)
                      || resource.data.visibility == 'public'
                      || resource.data.visibility == 'unlisted'
                      || (request.auth != null && resource.data.ownerId == request.auth.uid);

        // Only authenticated users can create timelines
        // Timeline must be owned by the authenticated user
        // Timeline must be in the owner's collection
        allow create: if request.auth != null &&
                        request.resource.data.ownerId == request.auth.uid &&
                        request.auth.uid == userId;

        // Only the owner can delete their timelines
        allow delete: if request.auth != null &&
                        resource.data.ownerId == request.auth.uid &&
                        request.auth.uid == userId;

        // Allow anyone to increment viewCount (for analytics)
        // Allow owners to update any field
        allow update: if (request.auth != null && resource.data.ownerId == request.auth.uid && request.auth.uid == userId)
                      || (request.resource.data.diff(resource.data).affectedKeys().hasOnly(['viewCount']));

        // Events subcollection (nested under timelines)
        // v0.5.0.1 - Event Persistence Optimization
        // v0.5.7 - Restrict based on parent timeline visibility
        match /events/{eventId} {
          // Allow reads only if parent timeline is public/unlisted or user is owner
          // Uses get() to check parent timeline visibility
          // Default to allowing read if visibility not set (backwards compatibility)
          allow read: if !('visibility' in get(/databases/$(database)/documents/users/$(userId)/timelines/$(timelineId)).data)
                        || get(/databases/$(database)/documents/users/$(userId)/timelines/$(timelineId)).data.visibility == 'public'
                        || get(/databases/$(database)/documents/users/$(userId)/timelines/$(timelineId)).data.visibility == 'unlisted'
                        || (request.auth != null && request.auth.uid == userId);

          // Only the timeline owner (authenticated user) can create/update/delete events
          allow create, update, delete: if request.auth != null &&
                                          request.auth.uid == userId;
        }
      }
    }

    // Activity logs collection (admin only)
    match /activityLogs/{logId} {
      // Only admins can read activity logs
      allow read: if request.auth != null &&
                     get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';

      // Only admins can create activity logs
      allow create: if request.auth != null &&
                       get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';

      // Activity logs cannot be updated or deleted
      allow update, delete: if false;
    }

    // Stats collection (v0.5.17 - Platform statistics aggregation)
    match /stats/{docId} {
      // Anyone can read platform stats (public dashboard data)
      allow read: if true;

      // Authenticated users can create/update stats (for cache refresh)
      // This enables the client-side stats aggregation to work
      allow create, update: if request.auth != null;

      // Stats documents cannot be deleted
      allow delete: if false;
    }
  }
}
